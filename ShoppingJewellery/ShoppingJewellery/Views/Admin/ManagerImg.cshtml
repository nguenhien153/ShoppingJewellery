@model IEnumerable<ShoppingJewellery.Models.ImageSub>
@{
    ViewBag.Title = "Manager Image";
    Layout = "~/Views/Layout/Admin/AdminLayout.cshtml";
    Page.name = Session["username"];
}

<link href="~/Content/css/Admin/Boxx.css" rel="stylesheet" />
<link href="~/Content/css/Admin/jquery.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/css/Admin/select.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/css/Admin/buttons.dataTables.min.css" rel="stylesheet" />
<link href="~/Content/css/Admin/forTable.css" rel="stylesheet" />
<link href="~/Content/css/Admin/jquery-ui.min.css?1" rel="stylesheet" />
<style>
    .field-icon {
        float: right;
        margin-top: -27px;
        margin-right: 46px;
        position: relative;
        z-index: 20;
        width: 20px;
    }

    .ui-autocomplete {
        z-index: 1510 !important;
    }

    table.dataTable thead .sorting_desc {
        background-image: url('../../Content/images/Icon/Admin/sort_desc.png');
    }

    table.dataTable thead .sorting_asc {
        background-image: url('../../Content/images/Icon/Admin/sort_asc.png');
    }

    table.dataTable thead .sorting {
        background-image: url('../../Content/images/Icon/Admin/sort_both.png');
    }

    .report_result {
        position: fixed;
        z-index: 2002;
        top: 10%;
        left: 50%;
        height: auto;
    }

        .report_result .image_report {
            width: 30px;
            margin-top: 5px;
        }

        .report_result p {
            font-weight: 400;
            line-height: 1.5;
            color: #4cff00;
            text-align: left;
            background-color: #fff;
        }

    .loader {
        border: 16px solid #f3f3f3;
        border-radius: 50%;
        border-top: 16px solid #3498db;
        border-bottom: 16px solid #3498db;
        width: 120px;
        height: 120px;
        -webkit-animation: spin 2s linear infinite; /* Safari */
        animation: spin 2s linear infinite;
        z-index: 2002;
        margin: auto;
    }
    /* Safari */
    @@-webkit-keyframes spin {
        0% {
            -webkit-transform: rotate(0deg);
        }

        100% {
            -webkit-transform: rotate(360deg);
        }
    }

    @@keyframes spin {
        0% {
            transform: rotate(0deg);
        }

        100% {
            transform: rotate(360deg);
        }
    }

    label {
        cursor: pointer;
    }

    #imagefile {
        opacity: 0;
        position: absolute;
        z-index: -1;
    }

    .image {
        opacity: 1;
        display: block;
        width: 100%;
        height: auto;
        transition: .5s ease;
        backface-visibility: hidden;
    }

    .middle {
        transition: .5s ease;
        opacity: 0;
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        -ms-transform: translate(-50%, -50%);
        text-align: center;
    }

    .backk:hover .image {
        opacity: 0.3;
    }

    .backk:hover .middle {
        opacity: 1;
    }
</style>
<div class="col-12 form-group m-auto">
    <div class="col-12 headerboxx"><h4><strong>Image</strong></h4></div>
    <div class="boxx col-12">
        <div style="padding:10px 0 15px 0">
            <div class="report_result" id="hien">
                <img src="" class="image_report" />
                <strong></strong>
            </div>
            <table class="table table-striped hover  " id="table" style="width:100%; ">
                <thead>
                    <tr>
                        <th class="text-center">No</th>
                        <th class="text-center">Style Code</th>
                        <th class="text-center">Image</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model)
                    {
                        <tr ID_Img="@item.imga.ID" ProductType="@item.Product_Type">
                            <td class="text-center align-middle">@item.imga.No</td>
                            <td class="text-center align-middle">@item.imga.Style_Colde</td>
                            <td class="text-center">
                                <img src="~/Content/images/Product_Image/@item.Product_Type/Image/@item.imga.Style_Colde/@item.imga.image1" style="width: 10vw" />
                            </td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<div class="modal fade" id="selectRow" tabindex="-1" role="dialog" aria-hidden="true" on>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h7 class="modal-title">
                    <img src="~/Content/images/Icon/Admin/amount_Copy_3-512.png" style="width:30px" />
                </h7>
                <button type="button" class=" btn btn-danger close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="contentt"></p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>

<div class="modal fade " id="model_common" tabindex="-1" role="dialog" aria-hidden="true" on>
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h7 class="modal-title"></h7>
                <button type="button" class="btn btn-danger close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
               

            </div>
        </div>
    </div>
</div>

<script src="~/Content/js/Admin/forTable.js?15"></script>
<script src="~/Content/js/Admin/jquery.dataTables.min.js"></script>
<script src="~/Content/js/Admin/dataTables.select.min.js"></script>
<script src="~/Content/js/Admin/dataTables.buttons.min.js"></script>
<script src="~/Content/js/Admin/Password.js"></script>
<script src="~/Content/js/Admin/Text/modalforProduct.js?5"></script>
<script src="~/Content/js/Admin/jquery-ui.min.js?1"></script>
<script>
    var admin = "@Session["admin"]";
    var stype;
    var no_no;
    var src;
    var id;
    var modalClone = $("#selectRow").clone();
    var reportClone = $("#hien").clone();
    var modalCommon = $("#model_common").clone();
    var rex_stylecode = /^[A-Z]+[A-z0-9\s.'-]*$/;

    function reportt(classdiv, classImg, srcImg, status, text) {
        $("." + classdiv).addClass("alert-" + status + " alert form-inline");
        $("." + classImg).attr("src", srcImg);
        $("." + classdiv + " strong").append("&nbsp; &nbsp;  " + text);

    }

  

    $(document).ready(function () {

        var table = $('#table').DataTable({
            "responsive": false,
            "lengthChange": false,
            "stateSave": true,
            "order": [[1, 'des']],
            "select": {
                "info": false
            },
            "columnDefs": [
                { "sortable": false, "targets": 2 }
            ],

        });

        new $.fn.dataTable.Buttons(table, {
            buttons: [
                {
                    className: 'btn',
                    attr: {
                        title: 'Create',
                        //id: 'copyButton',
                    },
                    text: '<img src="../Content/images/Icon/Admin/ChildRow_Create.png" style="width:40px" />',
                    action: function () {
                        $("#model_common").replaceWith(modalCommon.clone());
                        $("#model_common .modal-title ").text("Create Image For Item");
                        $("#model_common").modal("show");
                        $.when($("#model_common .modal-body").append(img_modal)).done(function () {
                            var No_img = false;
                            var Style_code = false;
                            var image_sub = false;
                            var report = $("#report").clone();

                            function readURL(input) {
                                var mimeType = input.files[0].type;
                                if (mimeType == "image/png" || mimeType == "image/jpeg") {
                                    if (input.files && input.files[0]) {
                                        var reader = new FileReader();
                                        reader.onload = function (e) {
                                            $('#img-upload').attr('src', e.target.result);
                                            image_sub = true;
                                        }
                                        reader.readAsDataURL(input.files[0]);
                                    }
                                } else {
                                    $('#img-upload').attr('src', "/Content/images/Icon/Admin/Icon_not.png");
                                    check_img = false;
                                }
                            }
                            $("#imagefile").change(function () {
                                readURL(this);
                            });

                            $("#Style_Colde").bind("change", function () {
                                Style_code = validateMinMax("Style_Colde", "result_Style_Colde", rex_stylecode, 8, 50);
                            });
                            $("#Style_Colde").on("focus", function () {
                                $(this).tooltip("show");
                            }).tooltip({
                                placement: "top",
                                trigger: "focus",
                                title: "Style Code must match the value in Item Table"
                            });
                            $("#Style_Colde").autocomplete({
                                source: '/Admin/GetStyle_code'
                            });

                            $("#No").bind("change", function () {
                                No_img = validatelessthan0Int("No", "result_No");
                            });
                            $("#No").on("focus", function () {
                                $(this).tooltip("show");
                            }).tooltip({
                                placement: "top",
                                trigger: "focus",
                                title: "Not accept negative number.<br/> Note: The No will be displayed in order from small to large."
                            });

                            $("#Save").click(function () {
                                if (Style_code == true && image_sub == true && No_img == true) {
                                    var data = new FormData();
                                    var files = $("#imagefile").get(0).files;
                                    if (files.length > 0 && image_sub == true) {
                                        console.log(files[0]);
                                        data.append("imagefile", files[0]);
                                    }
                                    data.append("Style_Colde", $("#Style_Colde").val());
                                    data.append("No", $("#No").val());

                                    $.ajax({
                                        url: '/Admin/CreateImg',
                                        type: "POST",
                                        contentType: false,
                                        processData: false,
                                        data: data,
                                        success: function (data) {
                                            $(".report_result").replaceWith(reportClone.clone());
                                            $("#model_common").modal('hide');
                                            if (data == "success") {
                                                $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_Success.png", "success", "Create Success")).done(function () {
                                                    $(".report_result").show();
                                                    setTimeout(function () {
                                                        location.reload();
                                                    }, 2000);
                                                });
                                            } else if (data == "fileFalse") {
                                                $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Create False. Image not valid !!!")).done(function () {
                                                    $(".report_result").show();
                                                    setTimeout(function () {
                                                        $(".report_result").fadeOut(800);
                                                    }, 2000);
                                                });
                                            } else if (data == "stylecodeFalse") {
                                                $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Create False. Style Code not exist !!!")).done(function () {
                                                    $(".report_result").show();
                                                    setTimeout(function () {
                                                        $(".report_result").fadeOut(800);
                                                    }, 2000);
                                                });
                                            } else if (data == "Noexist") {
                                                $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Create False. No has been exist !!!")).done(function () {
                                                    $(".report_result").show();
                                                    setTimeout(function () {
                                                        $(".report_result").fadeOut(800);
                                                    }, 2000);
                                                });
                                            } else {
                                                $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Create False. System Error !!!")).done(function () {
                                                    $(".report_result").show();
                                                    setTimeout(function () {
                                                        $(".report_result").fadeOut(800);
                                                    }, 2000);
                                                });
                                            }
                                        },
                                        error: function (xhr, error, status) {
                                            alert("Error: " + status);
                                        }
                                    })
                                } else {
                                    $("#model_common #report").replaceWith(report.clone());
                                    $("#model_common #report").append("<strong>Your Infor not valid. Please check against !!!</strong>");
                                    $("#model_common #report").addClass("alert-warning col-12 alert");
                                    setTimeout(function () {
                                        $("#model_common #report").fadeOut(800);
                                    }, 2500);
                                }
                            });
                            $.when($("#model_common .loader").fadeOut(2000)).done(function () {
                                $("#Save").text("Create");
                                $("#img_group").fadeIn(1000);
                            });

                        });

                    },
                },
                {
                    className: 'btn',
                    attr: {
                        title: 'Edit',
                        //id: 'copyButton',
                    },
                    text: '<img src="../Content/images/Icon/Admin/ChildRow_Edit.png" style="width:40px" />',
                    action: function () {
                        if (stype != null && no_no != null && id != null && src != null) {
                            $("#model_common").replaceWith(modalCommon.clone());
                            $("#model_common .modal-title ").text("Edit Image");
                            $("#model_common").modal("show");
                            $.when($("#model_common .modal-body").append(img_modal)).done(function () {
                                var No_img = true;
                                var Style_code = true;
                                var image_sub = true;
                                var report = $("#report").clone();

                                function readURL(input) {
                                    var mimeType = input.files[0].type;
                                    if (mimeType == "image/png" || mimeType == "image/jpeg") {
                                        if (input.files && input.files[0]) {
                                            var reader = new FileReader();
                                            reader.onload = function (e) {
                                                $('#img-upload').attr('src', e.target.result);
                                                image_sub = true;
                                            }
                                            reader.readAsDataURL(input.files[0]);
                                        }
                                    } else {
                                        $('#img-upload').attr('src', "/Content/images/Icon/Admin/Icon_not.png");
                                        check_img = false;
                                    }
                                }
                                $("#imagefile").change(function () {
                                    readURL(this);
                                });
                                $("#img-upload").attr("src", src);


                                $("#Style_Colde").bind("change", function () {
                                    Style_code = validateMinMax("Style_Colde", "result_Style_Colde", rex_stylecode, 8, 50);
                                });
                                $("#Style_Colde").on("focus", function () {
                                    $(this).tooltip("show");
                                }).tooltip({
                                    placement: "top",
                                    trigger: "focus",
                                    title: "Style Code must match the value in Item Table"
                                });
                                $("#Style_Colde").autocomplete({
                                    source: '/Admin/GetStyle_code'
                                });
                                $("#Style_Colde").val(stype);


                                $("#No").bind("change", function () {
                                    No_img = validatelessthan0Int("No", "result_No");
                                });
                                $("#No").on("focus", function () {
                                    $(this).tooltip("show");
                                }).tooltip({
                                    placement: "top",
                                    trigger: "focus",
                                    title: "Not accept negative number.<br/> Note: The No will be displayed in order from small to large."
                                    });
                                $("#No").val(no_no);
                             

                                $("#Save").click(function () {
                                    if (Style_code == true && image_sub == true && No_img == true) {
                                        var data = new FormData();
                                        if ($("#img-upload").attr("src") != src) {
                                            var files = $("#imagefile").get(0).files;
                                            if (files.length > 0 && image_sub == true) {
                                                console.log(files[0]);
                                                data.append("imagefile", files[0]);
                                            }
                                        }
                                        data.append("Style_Colde", $("#Style_Colde").val());
                                        data.append("No", $("#No").val());
                                        data.append("ID", id);
                                        $.ajax({
                                            url: '/Admin/EditImg',
                                            type: "POST",
                                            contentType: false,
                                            processData: false,
                                            data: data,
                                            success: function (data) {
                                                $(".report_result").replaceWith(reportClone.clone());
                                                $("#model_common").modal('hide');
                                                if (data == "success") {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_Success.png", "success", "Edit Success")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            location.reload();
                                                        }, 2000);
                                                    });
                                                } else if (data == "false") {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Edit False. Image not exist in DB !!!")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            $(".report_result").fadeOut(800);
                                                        }, 2000);
                                                    });
                                                } else if (data == "fileFalse") {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Edit False. Image not valid (>10MB) !!!")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            $(".report_result").fadeOut(800);
                                                        }, 2000);
                                                    });
                                                } else if (data == "stylecodeFalse") {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Edit False. Style Code not exist !!!")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            $(".report_result").fadeOut(800);
                                                        }, 2000);
                                                    });
                                                } else if (data == "Noexist") {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Edit False. No has been exist !!!")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            $(".report_result").fadeOut(800);
                                                        }, 2000);
                                                    });
                                                } else {
                                                    $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Create False. System Error !!!")).done(function () {
                                                        $(".report_result").show();
                                                        setTimeout(function () {
                                                            $(".report_result").fadeOut(800);
                                                        }, 2000);
                                                    });
                                                }
                                            },
                                            error: function (xhr, error, status) {
                                                alert("Error: " + status);
                                            }
                                        })
                                    } else {
                                        $("#model_common #report").replaceWith(report.clone());
                                        $("#model_common #report").append("<strong>Your Infor not valid. Please check against !!!</strong>");
                                        $("#model_common #report").addClass("alert-warning col-12 alert");
                                        setTimeout(function () {
                                            $("#model_common #report").fadeOut(800);
                                        }, 2500);
                                    }
                                });
                                $.when($("#model_common .loader").fadeOut(2000)).done(function () {
                                    $("#img_group").fadeIn(1000);
                                });

                            });
                        } else {
                            $("#selectRow").replaceWith(modalClone.clone());
                            $("#contentt").text("Please select record.");
                            $('#selectRow').modal('show');
                        }
                    }
                },
                {
                    className: 'btn',
                    attr: {
                        title: 'Delete',
                        id: 'DeleteItem',
                    },
                    text: '<img src="../Content/images/Icon/Admin/ChildRow_Delete.png" style="width:40px" />',
                    action: function () {
                        if (admin != "SuperAdmin") {
                            return;
                        }

                        $("#selectRow").replaceWith(modalClone.clone());

                        if (id != null && stype != null && src != null && no_no != null) {
                            $("#selectRow .modal-title").empty();
                            $("#selectRow .modal-title").text("Delete Image");
                            $("#selectRow .modal-body").append("Delete Image No: " + no_no + "." + "<br/> Are you sure?");
                            $("#selectRow .modal-footer").prepend('<button class="accept btn btn-success" id="detele_brand">Yes</button>');
                            $("#selectRow .modal-footer").children("button").eq(1).text("No");
                            $('#selectRow').modal('show');
                            $("#detele_brand").click(function () {
                                $.ajax({
                                    url: '/Admin/DeleteImg',
                                    data: {
                                        id_item: id,
                                        Style_Colde: stype,
                                        filename: src.substring(src.lastIndexOf("/") + 1)
                                    },
                                    type: "POST",
                                    success: function (data) {
                                        $('#selectRow').modal('hide');
                                        $(".report_result").replaceWith(reportClone.clone());
                                        if (data == "success") {
                                            $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_Success.png", "success", "Delete Success")).done(function () {
                                                $(".report_result").show();
                                                setTimeout(function () {
                                                    location.reload();
                                                }, 2000);

                                            });
                                        } else if (data == "false") {
                                            $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Delete False. Image not exist in DB !!!")).done(function () {
                                                $(".report_result").show();
                                                setTimeout(function () {
                                                    $(".report_result").fadeOut(800);
                                                }, 2000);
                                            });
                                        } else if (data == "fileFalse") {
                                            $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Delete False. An error occurred while deleting the file")).done(function () {
                                                $(".report_result").show();
                                                setTimeout(function () {
                                                    $(".report_result").fadeOut(800);
                                                }, 2500);
                                            });
                                        } else {
                                            $.when(reportt("report_result", "image_report", "/Content/images/Icon/Admin/icon_false.png", "danger", "Delete False. System Error !!!")).done(function () {
                                                $(".report_result").show();
                                                setTimeout(function () {
                                                    $(".report_result").fadeOut(800);
                                                }, 2500);

                                            });
                                        }
                                    },
                                    error: function (xhr, error, status) {
                                        alert("Error: " + status);
                                    }
                                });
                            });
                        } else {
                            $("#selectRow").replaceWith(modalClone.clone());
                            $("#selectRow .modal-body").text("Please select record.");
                            $('#selectRow').modal('show');
                        }
                    }
                }
            ]
        });



        table.buttons(0, null).container().prependTo(
            table.table().container()
        );
        remove_ClassButton();
        table_inital("table");

        $('#table tbody').on('click', 'tr', function () {
            no_no = $(this).children("td").eq(0).text().replace(/\s/g, "");
            stype = $(this).children("td").eq(1).text();
            id = $(this).attr("ID_Img");
            src = $(this).children("td").children("img").attr("src");
        });
        if (admin != "SuperAdmin") {
            $("#DeleteItem").hide();
        }
    });
</script>



